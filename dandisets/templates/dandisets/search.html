{% extends 'dandisets/base.html' %}

{% block title %}Search Dandisets - DANDI{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">
            <i class="fas fa-search"></i> Search DANDI Datasets
        </h1>
        
        <!-- Search Form -->
        <div class="filter-section">
            <form method="get" id="searchForm">
                <!-- Search & Sort Row -->
                <div class="row mb-2">
                    <!-- Text Search -->
                    <div class="col-md-8 mb-2">
                        <label for="search" class="form-label form-label-sm">
                            <i class="fas fa-font"></i> Text Search
                        </label>
                        <input type="text" 
                               class="form-control form-control-sm" 
                               id="search" 
                               name="search" 
                               value="{{ current_filters.search|default:'' }}"
                               placeholder="Search name, description, keywords...">
                    </div>
                    
                    <!-- Sort Order -->
                    <div class="col-md-4 mb-2">
                        <label for="order_by" class="form-label form-label-sm">
                            <i class="fas fa-sort"></i> Sort By
                        </label>
                        <select class="form-select form-select-sm" id="order_by" name="order_by">
                            <option value="name" {% if current_filters.order_by == 'name' %}selected{% endif %}>Name (A-Z)</option>
                            <option value="-name" {% if current_filters.order_by == '-name' %}selected{% endif %}>Name (Z-A)</option>
                            <option value="-date_published" {% if current_filters.order_by == '-date_published' or not current_filters.order_by %}selected{% endif %}>Newest Published</option>
                            <option value="date_published" {% if current_filters.order_by == 'date_published' %}selected{% endif %}>Oldest Published</option>
                            <option value="-created" {% if current_filters.order_by == '-created' %}selected{% endif %}>Newest Created</option>
                            <option value="created" {% if current_filters.order_by == 'created' %}selected{% endif %}>Oldest Created</option>
                            <option value="-assets_summary__number_of_bytes" {% if current_filters.order_by == '-assets_summary__number_of_bytes' %}selected{% endif %}>Largest Size</option>
                            <option value="assets_summary__number_of_bytes" {% if current_filters.order_by == 'assets_summary__number_of_bytes' %}selected{% endif %}>Smallest Size</option>
                            <option value="-assets_summary__number_of_subjects" {% if current_filters.order_by == '-assets_summary__number_of_subjects' %}selected{% endif %}>Most Subjects</option>
                            <option value="assets_summary__number_of_subjects" {% if current_filters.order_by == 'assets_summary__number_of_subjects' %}selected{% endif %}>Least Subjects</option>
                            <option value="-assets_summary__number_of_files" {% if current_filters.order_by == '-assets_summary__number_of_files' %}selected{% endif %}>Most Files</option>
                            <option value="assets_summary__number_of_files" {% if current_filters.order_by == 'assets_summary__number_of_files' %}selected{% endif %}>Least Files</option>
                        </select>
                    </div>
                </div>
                
                <!-- Biological Filters -->
                <div class="row mb-2">
                    <div class="col-md-3 mb-2">
                        <label for="species" class="form-label form-label-sm">
                            <i class="fas fa-paw"></i> Species
                        </label>
                        <select class="form-select form-select-sm" id="species" name="species" multiple size="3">
                            {% for species in filter_options.species %}
                                <option value="{{ species.id }}" 
                                        {% if species.id|stringformat:"s" in current_filters.species or species.name in current_filters.species %}selected{% endif %}>
                                    {{ species.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-3 mb-2">
                        <label for="anatomy" class="form-label form-label-sm">
                            <i class="fas fa-brain"></i> Anatomy
                        </label>
                        <select class="form-select form-select-sm" id="anatomy" name="anatomy" multiple size="3">
                            {% for anatomy in filter_options.anatomy %}
                                <option value="{{ anatomy.id }}" 
                                        {% if anatomy.id|stringformat:"s" in current_filters.anatomy or anatomy.name in current_filters.anatomy %}selected{% endif %}>
                                    {{ anatomy.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-3 mb-2">
                        <label for="approach" class="form-label form-label-sm">
                            <i class="fas fa-microscope"></i> Approach
                        </label>
                        <select class="form-select form-select-sm" id="approach" name="approach" multiple size="3">
                            {% for approach in filter_options.approaches %}
                                <option value="{{ approach.id }}" 
                                        {% if approach.id|stringformat:"s" in current_filters.approach or approach.name in current_filters.approach %}selected{% endif %}>
                                    {{ approach.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-3 mb-2">
                        <label for="measurement_technique" class="form-label form-label-sm">
                            <i class="fas fa-tools"></i> Measurement
                        </label>
                        <select class="form-select form-select-sm" id="measurement_technique" name="measurement_technique" multiple size="3">
                            {% for technique in filter_options.measurement_techniques %}
                                <option value="{{ technique.id }}" 
                                        {% if technique.id|stringformat:"s" in current_filters.measurement_technique or technique.name in current_filters.measurement_technique %}selected{% endif %}>
                                    {{ technique.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Technical & Data Filters -->
                <div class="row mb-2">
                    <div class="col-md-3 mb-2">
                        <label for="file_format" class="form-label form-label-sm">
                            <i class="fas fa-file-code"></i> File Format
                        </label>
                        <select class="form-select form-select-sm" id="file_format" name="file_format" multiple size="3">
                            {% for format_dict in filter_options.file_formats %}
                                <option value="{{ format_dict.value }}" 
                                        {% if format_dict.value in current_filters.file_format %}selected{% endif %}>
                                    {{ format_dict.display_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-4 mb-2">
                        <label for="data_standards" class="form-label form-label-sm">
                            <i class="fas fa-certificate"></i> Data Standards
                        </label>
                        <select class="form-select form-select-sm" id="data_standards" name="data_standards" multiple size="3">
                            {% for standard in filter_options.data_standards %}
                                <option value="{{ standard.id }}" 
                                        {% if standard.id|stringformat:"s" in current_filters.data_standards or standard.name in current_filters.data_standards %}selected{% endif %}>
                                    {{ standard.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-4 mb-2">
                        <label for="variables_measured" class="form-label form-label-sm">
                            <i class="fas fa-chart-line"></i> Variables Measured
                        </label>
                        <select class="form-select form-select-sm" id="variables_measured" name="variables_measured" multiple size="3">
                            {% for variable_tuple in filter_options.variables_measured %}
                                <option value="{{ variable_tuple.0 }}" 
                                        {% if variable_tuple.0 in current_filters.variables_measured %}selected{% endif %}>
                                    {{ variable_tuple.1 }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Numeric Filters -->
                <div class="row mb-2">
                    <div class="col-md-3 mb-2">
                        <label class="form-label form-label-sm">
                            <i class="fas fa-users"></i> Subjects
                        </label>
                        <div class="row g-1">
                            <div class="col-6">
                                <input type="number" 
                                       class="form-control form-control-sm" 
                                       name="min_subjects" 
                                       value="{{ current_filters.min_subjects|default:'' }}"
                                       placeholder="Min" 
                                       min="0">
                            </div>
                            <div class="col-6">
                                <input type="number" 
                                       class="form-control form-control-sm" 
                                       name="max_subjects" 
                                       value="{{ current_filters.max_subjects|default:'' }}"
                                       placeholder="Max" 
                                       min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-2">
                        <label class="form-label form-label-sm">
                            <i class="fas fa-file"></i> Files
                        </label>
                        <div class="row g-1">
                            <div class="col-6">
                                <input type="number" 
                                       class="form-control form-control-sm" 
                                       name="min_files" 
                                       value="{{ current_filters.min_files|default:'' }}"
                                       placeholder="Min" 
                                       min="0">
                            </div>
                            <div class="col-6">
                                <input type="number" 
                                       class="form-control form-control-sm" 
                                       name="max_files" 
                                       value="{{ current_filters.max_files|default:'' }}"
                                       placeholder="Max" 
                                       min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-2">
                        <label class="form-label form-label-sm">
                            <i class="fas fa-hdd"></i> Size (GB)
                        </label>
                        <div class="row g-1">
                            <div class="col-6">
                                <input type="number" 
                                       class="form-control form-control-sm" 
                                       name="min_size" 
                                       value="{{ current_filters.min_size|default:'' }}"
                                       placeholder="Min" 
                                       min="0" 
                                       step="0.1">
                            </div>
                            <div class="col-6">
                                <input type="number" 
                                       class="form-control form-control-sm" 
                                       name="max_size" 
                                       value="{{ current_filters.max_size|default:'' }}"
                                       placeholder="Max" 
                                       min="0" 
                                       step="0.1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-2">
                        <label class="form-label form-label-sm">
                            <i class="fas fa-calendar"></i> Pub. Date
                        </label>
                        <div class="row g-1">
                            <div class="col-6">
                                <input type="date" 
                                       class="form-control form-control-sm" 
                                       name="pub_date_start" 
                                       value="{{ current_filters.pub_date_start|default:'' }}"
                                       title="Start date">
                            </div>
                            <div class="col-6">
                                <input type="date" 
                                       class="form-control form-control-sm" 
                                       name="pub_date_end" 
                                       value="{{ current_filters.pub_date_end|default:'' }}"
                                       title="End date">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Asset-Level Filters -->
                <div class="mb-3">
                    <h5 class="mb-2">
                        <i class="fas fa-file"></i> Asset-Level Filters
                    </h5>
                    <div class="row">
                        <!-- Asset Path Search -->
                        <div class="col-md-4 mb-2">
                            <label for="asset_path" class="form-label form-label-sm">
                                <i class="fas fa-folder-open"></i> File Path/Name
                            </label>
                            <input type="text" 
                                   class="form-control form-control-sm" 
                                   id="asset_path" 
                                   name="asset_path" 
                                   value="{{ current_filters.asset_path|default:'' }}"
                                   placeholder="Search file paths...">
                        </div>
                        
                        <!-- Dandiset ID Filter -->
                        <div class="col-md-3 mb-2">
                            <label for="asset_dandiset_id" class="form-label form-label-sm">
                                <i class="fas fa-database"></i> Dandiset ID
                            </label>
                            <input type="text" 
                                   class="form-control form-control-sm" 
                                   id="asset_dandiset_id" 
                                   name="asset_dandiset_id" 
                                   value="{{ current_filters.asset_dandiset_id|default:'' }}"
                                   placeholder="e.g., 000001">
                        </div>
                        
                        <!-- Sex Filter -->
                        <div class="col-md-3 mb-2">
                            <label for="asset_sex" class="form-label form-label-sm">
                                <i class="fas fa-venus-mars"></i> Subject Sex
                            </label>
                            <select class="form-select form-select-sm" id="asset_sex" name="asset_sex" multiple size="2">
                                {% for sex in filter_options.sex_types %}
                                    <option value="{{ sex.id }}" 
                                            {% if sex.id|stringformat:"s" in current_filters.asset_sex or sex.name in current_filters.asset_sex %}selected{% endif %}>
                                        {{ sex.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Asset File Size Filter -->
                        <div class="col-md-2 mb-2">
                            <label class="form-label form-label-sm">
                                <i class="fas fa-hdd"></i> File Size (MB)
                            </label>
                            <div class="row g-1">
                                <div class="col-6">
                                    <input type="number" 
                                           class="form-control form-control-sm" 
                                           name="asset_min_size" 
                                           value="{{ current_filters.asset_min_size|default:'' }}"
                                           placeholder="Min" 
                                           min="0" 
                                           step="0.1">
                                </div>
                                <div class="col-6">
                                    <input type="number" 
                                           class="form-control form-control-sm" 
                                           name="asset_max_size" 
                                           value="{{ current_filters.asset_max_size|default:'' }}"
                                           placeholder="Max" 
                                           min="0" 
                                           step="0.1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="row">
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search"></i> Search
                        </button>
                        <a href="{% url 'dandisets:search' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-undo"></i> Clear Filters
                        </a>
                    </div>
                </div>
            </form>
        </div>
        
        
        <!-- Search Results Summary -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Search Results</h3>
            <div class="stats-card">
                <div class="row text-center">
                    <div class="col">
                        <div class="h4 mb-0">{{ total_results }}</div>
                        <small>Dataset{{ total_results|pluralize }}</small>
                    </div>
                    {% if stats.min_subjects and stats.max_subjects %}
                    <div class="col border-start">
                        <div class="h6 mb-0">{{ stats.min_subjects }}-{{ stats.max_subjects }}</div>
                        <small>Subjects Range</small>
                    </div>
                    {% endif %}
                    {% if stats.min_size_gb and stats.max_size_gb %}
                    <div class="col border-start">
                        <div class="h6 mb-0">{{ stats.min_size_gb }}-{{ stats.max_size_gb }} GB</div>
                        <small>Size Range</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Search Results -->
        {% if dandisets_with_counts %}
            <div class="row">
                {% for item in dandisets_with_counts %}
                {% with dandiset=item.dandiset %}
                <div class="col-md-12 mb-4">
                    <div class="card dandiset-card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5 class="card-title">
                                        <a href="https://dandiarchive.org/dandiset/{{ dandiset.dandi_id|slice:'6:' }}" 
                                           class="text-decoration-none"
                                           target="_blank"
                                           rel="noopener noreferrer">
                                            {{ dandiset.name }}
                                            <i class="fas fa-external-link-alt ms-1" style="font-size: 0.8em;"></i>
                                        </a>
                                    </h5>
                                    <p class="card-text text-muted mb-2">
                                        <strong>ID:</strong> {{ dandiset.dandi_id }}
                                    </p>
                                    <p class="card-text">
                                        {{ dandiset.description|truncatewords:30 }}
                                    </p>
                                    
                                    <!-- Tags for anatomy, species, etc. -->
                                    <div class="mb-2">
                                        {% for about in dandiset.dandisetabout_set.all %}
                                            {% if about.anatomy %}
                                                <span class="badge badge-anatomy me-1">
                                                    <i class="fas fa-brain"></i> {{ about.anatomy.name }}
                                                </span>
                                            {% endif %}
                                        {% endfor %}
                                        
                                        {% if dandiset.assets_summary %}
                                            {% for species_rel in dandiset.assets_summary.assetssummaryspecies_set.all %}
                                                <span class="badge badge-species me-1">
                                                    <i class="fas fa-paw"></i> {{ species_rel.species.name }}
                                                </span>
                                            {% endfor %}
                                            
                                            {% for approach_rel in dandiset.assets_summary.assetssummaryapproach_set.all %}
                                                <span class="badge badge-approach me-1">
                                                    <i class="fas fa-microscope"></i> {{ approach_rel.approach.name }}
                                                </span>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    {% if dandiset.assets_summary %}
                                    <div class="text-end">
                                        <div class="mb-2">
                                            <i class="fas fa-users text-primary"></i>
                                            <strong>{{ dandiset.assets_summary.number_of_subjects|default:"N/A" }}</strong> subjects
                                        </div>
                                        <div class="mb-2">
                                            <i class="fas fa-file text-primary"></i>
                                            <strong>{{ dandiset.assets_summary.number_of_files }}</strong> files
                                        </div>
                                        <div class="mb-2">
                                            <i class="fas fa-hdd text-primary"></i>
                                            <span class="size-display">
                                                {% if dandiset.assets_summary.number_of_bytes %}
                                                    {{ dandiset.assets_summary.number_of_bytes|filesizeformat }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </span>
                                        </div>
                                        {% if dandiset.date_published %}
                                        <div class="text-muted">
                                            <small>
                                                <i class="fas fa-calendar"></i>
                                                Published {{ dandiset.date_published|date:"M d, Y" }}
                                            </small>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Assets Accordion -->
                            <div class="accordion mt-3" id="assetsAccordion{{ forloop.counter }}">
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="assetsHeading{{ forloop.counter }}">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#assetsCollapse{{ forloop.counter }}" aria-expanded="false" aria-controls="assetsCollapse{{ forloop.counter }}" data-dandiset-id="{{ dandiset.id }}" data-collapse-id="assetsCollapse{{ forloop.counter }}">
                                            <i class="fas fa-file-alt text-success me-2"></i>
                                            <strong>View Assets</strong>
                                            {% if item.total_assets %}
                                            <small class="text-muted ms-2" id="assetCount{{ dandiset.id }}">
                                                <span class="asset-count-display" 
                                                      data-total="{{ item.total_assets }}" 
                                                      data-filtered="{{ item.filtered_assets }}"
                                                      data-has-filters="{{ has_asset_filters|yesno:'true,false' }}">
                                                    {% if has_asset_filters %}
                                                        ({{ item.filtered_assets }} of {{ item.total_assets }} files match filters)
                                                    {% else %}
                                                        ({{ item.total_assets }} total files)
                                                    {% endif %}
                                                </span>
                                            </small>
                                            {% endif %}
                                        </button>
                                    </h2>
                                    <div id="assetsCollapse{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="assetsHeading{{ forloop.counter }}" data-bs-parent="#assetsAccordion{{ forloop.counter }}">
                                        <div class="accordion-body">
                                            <div id="assetsPagination{{ dandiset.id }}" class="assets-pagination-container">
                                                <!-- Pagination controls will be loaded here -->
                                            </div>
                                            <div id="assetsList{{ dandiset.id }}" class="assets-list">
                                                <div class="text-center py-3">
                                                    <i class="fas fa-spinner fa-spin"></i> Loading assets...
                                                </div>
                                            </div>
                                            <div id="assetsPaginationBottom{{ dandiset.id }}" class="assets-pagination-bottom">
                                                <!-- Bottom pagination controls will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endwith %}
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <nav aria-label="Search results pagination">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' and value %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">
                                Previous
                            </a>
                        </li>
                    {% endif %}
                    
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' and value %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">
                                    {{ num }}
                                </a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' and value %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">
                                Next
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
            
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No datasets found</h4>
                <p class="text-muted">Try adjusting your search criteria or clearing filters.</p>
            </div>
        {% endif %}
    </div>
</div>
<style>
.asset-item {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
}

.asset-item:hover {
    background-color: #e9ecef;
}

.asset-path code {
    background: none;
    color: #495057;
    font-size: 0.9em;
}

.assets-section {
    background-color: #fff;
    border-top: 1px solid #dee2e6;
    padding-top: 1rem;
}

.collapse .card-body {
    background-color: #f8f9fa;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Store loaded assets to avoid reloading
const loadedAssets = new Set();

/**
 * Build clean URL, enforcing comma-separated syntax for multi-value fields (key=a,b,c).
 * Multi-select fields that must be comma-joined:
 *   species, anatomy, approach, measurement_technique, file_format, data_standards, variables_measured, asset_sex
 * All other fields are appended as single values if non-empty.
 */
function buildCleanUrl(form) {
    const params = new URLSearchParams();

    // Define multi-value field names we will encode as comma-separated lists
    const multiValueFields = new Set([
        'species',
        'anatomy',
        'approach',
        'measurement_technique',
        'file_format',
        'data_standards',
        'variables_measured',
        'asset_sex'
    ]);

    // Collect values per field
    const fieldValues = new Map();

    const elements = form.querySelectorAll('input, select');
    elements.forEach(element => {
        if (!element.name) return;
        const name = element.name;

        if (element.tagName.toLowerCase() === 'select' && element.multiple) {
            // Gather selected values for multi-selects
            const selectedOptions = Array.from(element.selectedOptions);
            const values = selectedOptions
                .map(opt => {
                    if (!opt.value) return null;
                    // variables_measured uses label text; others use value
                    return name === 'variables_measured' ? opt.textContent.trim() : opt.value;
                })
                .filter(v => v && v.trim() !== '');

            if (values.length > 0) {
                fieldValues.set(name, (fieldValues.get(name) || []).concat(values));
            }
        } else if (element.type === 'text' || element.type === 'number' || element.type === 'date') {
            const val = (element.value || '').trim();
            if (val !== '') {
                fieldValues.set(name, [val]);
            }
        } else if (element.tagName.toLowerCase() === 'select') {
            // Single select
            if (element.value && element.value.trim() !== '') {
                if (name === 'order_by') {
                    fieldValues.set(name, [element.value]);
                } else {
                    const selectedOption = element.options[element.selectedIndex];
                    fieldValues.set(name, [selectedOption ? selectedOption.textContent.trim() : element.value]);
                }
            }
        }
    });

    // Write params, encoding multi-value fields as comma-separated single keys
    for (const [name, values] of fieldValues.entries()) {
        if (!values || values.length === 0) continue;
        if (multiValueFields.has(name)) {
            // Deduplicate and join with commas
            const joined = Array.from(new Set(values)).join(',');
            params.set(name, joined);
        } else {
            // Single value field: use the first non-empty value
            params.set(name, values[0]);
        }
    }

    const queryString = params.toString();
    return window.location.pathname + (queryString ? '?' + queryString : '');
}

// Function to get current search filters from the form
/**
 * Return current filters encoded like buildCleanUrl does (comma-separated multi-values).
 * Used when fetching assets so it matches backend expectations.
 */
function getCurrentFilters() {
    const form = document.getElementById('searchForm');
    // Reuse the same logic as buildCleanUrl to ensure consistency
    const url = buildCleanUrl(form);
    const qs = url.split('?')[1] || '';
    return qs;
}

// Function to load assets for a dandiset
function loadDandisetAssets(dandisetId, collapseId) {
    // Check if already loaded
    if (loadedAssets.has(dandisetId)) {
        return;
    }
    
    // Mark as loaded
    loadedAssets.add(dandisetId);
    
    // Get current filters
    const filters = getCurrentFilters();
    
    // Make AJAX request
    const url = `{% url 'dandisets:api_dandiset_assets' 0 %}`.replace('0', dandisetId) + (filters ? '?' + filters : '');
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            // Update assets list
            document.getElementById(`assetsList${dandisetId}`).innerHTML = data.assets_html;
            
            // Update pagination (only show if there are multiple pages)
            if (data.total_pages > 1) {
                document.getElementById(`assetsPagination${dandisetId}`).innerHTML = data.pagination_html;
                document.getElementById(`assetsPaginationBottom${dandisetId}`).innerHTML = data.pagination_html;
            }
            
            // Update accordion button text with both counts
            updateAccordionButtonText(dandisetId, data.total_count, data.total_assets_count);
        })
        .catch(error => {
            console.error('Error loading assets:', error);
            document.getElementById(`assetsList${dandisetId}`).innerHTML = 
                '<div class="text-center py-3 text-danger"><i class="fas fa-exclamation-triangle"></i> Error loading assets</div>';
        });
}

// Function to update accordion button text with counts
function updateAccordionButtonText(dandisetId, filteredCount, totalCount) {
    // Find the accordion button for this dandiset
    const button = document.querySelector(`[data-dandiset-id="${dandisetId}"]`);
    if (!button) return;
    
    // Find the text element within the button
    const textContainer = button.querySelector('.asset-count-display');
    if (!textContainer) return;
    
    // Check if filters are applied - use a more reliable method than URL parsing
    // by checking if the filtered count is different from total count
    const hasFilters = filteredCount !== totalCount;
    
    // Update text based on whether there are filters applied
    if (!hasFilters) {
        textContainer.textContent = `(${totalCount} total files)`;
    } else {
        textContainer.textContent = `(${filteredCount} of ${totalCount} files match filters)`;
    }
}

// Function to load a specific page of assets
function loadAssetsPage(dandisetId, page) {
    // Get current filters
    const filters = getCurrentFilters();
    
    // Build URL with page parameter
    let url = `{% url 'dandisets:api_dandiset_assets' 0 %}`.replace('0', dandisetId);
    const params = new URLSearchParams(filters);
    params.set('page', page);
    url += '?' + params.toString();
    
    // Show loading spinner
    document.getElementById(`assetsList${dandisetId}`).innerHTML = 
        '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Loading assets...</div>';
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            // Update assets list
            document.getElementById(`assetsList${dandisetId}`).innerHTML = data.assets_html;
            
            // Update pagination
            if (data.total_pages > 1) {
                document.getElementById(`assetsPagination${dandisetId}`).innerHTML = data.pagination_html;
                document.getElementById(`assetsPaginationBottom${dandisetId}`).innerHTML = data.pagination_html;
            } else {
                document.getElementById(`assetsPagination${dandisetId}`).innerHTML = '';
                document.getElementById(`assetsPaginationBottom${dandisetId}`).innerHTML = '';
            }
            
            // Update accordion button text with both counts
            updateAccordionButtonText(dandisetId, data.total_count, data.total_assets_count);
        })
        .catch(error => {
            console.error('Error loading assets page:', error);
            document.getElementById(`assetsList${dandisetId}`).innerHTML = 
                '<div class="text-center py-3 text-danger"><i class="fas fa-exclamation-triangle"></i> Error loading assets</div>';
        });
}

// Auto-submit form when filters change
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('searchForm');
    const selects = form.querySelectorAll('select[multiple]');
    const orderBySelect = form.querySelector('#order_by');
    
    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default form submission
        
        // Reset button appearance
        const searchButton = document.querySelector('button[type="submit"]');
        if (searchButton) {
            searchButton.classList.remove('btn-warning');
            searchButton.classList.add('btn-primary');
            searchButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
        }
        
        const cleanUrl = buildCleanUrl(form);
        window.location.href = cleanUrl;
    });
    
    // Handle multi-select changes - removed auto-submission to allow multiple selections
    // Users will need to click the Search button to apply filters
    
    // Optionally add visual feedback when selections change
    selects.forEach(select => {
        select.addEventListener('change', function() {
            // Add visual feedback that filters have changed
            const searchButton = document.querySelector('button[type="submit"]');
            if (searchButton && !searchButton.classList.contains('btn-warning')) {
                searchButton.classList.remove('btn-primary');
                searchButton.classList.add('btn-warning');
                searchButton.innerHTML = '<i class="fas fa-search"></i> Apply Filters';
            }
        });
    });
    
    // Handle order by dropdown change
    if (orderBySelect) {
        orderBySelect.addEventListener('change', function() {
            const cleanUrl = buildCleanUrl(form);
            window.location.href = cleanUrl;
        });
    }
    
    // Handle accordion button clicks to load assets
    document.addEventListener('click', function(e) {
        if (e.target.closest('[data-bs-toggle="collapse"][data-dandiset-id]')) {
            const button = e.target.closest('[data-bs-toggle="collapse"][data-dandiset-id]');
            const dandisetId = button.dataset.dandisetId;
            const collapseId = button.dataset.collapseId;
            
            // Load assets when accordion is opened
            setTimeout(() => {
                loadDandisetAssets(parseInt(dandisetId), collapseId);
            }, 100); // Small delay to ensure accordion starts opening
        }
    });
});
</script>
{% endblock %}
